<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>ncnn webassembly nanodet</title>
    <style>
      video {
        /*             position: absolute; */
        /*             visibility: hidden; */
      }
      canvas {
        border: 1px solid black;
      }
    </style>
  </head>

  <body>
    <div>
      <h1>ncnn webassembly nanodet</h1>
      <div>
        <button disabled id="switch-camera-btn" style="height: 48px">
          Switch Camera
        </button>
      </div>
      <div>
        <canvas id="canvas" width="640"></canvas>
      </div>
      <video id="video" playsinline autoplay></video>
    </div>

    <script src="./nanodet-basic.js"></script>
    <script type="text/javascript">
      var Module;

      var wasmModuleLoaded = false;
      var wasmModuleLoadedCallbacks = [];

      var shouldFaceUser = true;
      var stream = null;
      var w = 640;
      var h = 480;

      var pointer = null;
      window.addEventListener("DOMContentLoaded", async function () {
        Module = await createNanoDet();
        wasmModuleLoaded = true
        // console.log('dom loaded')
        var isStreaming = false;
        switchcamerabtn = document.getElementById("switch-camera-btn");
        video = document.getElementById("video");
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");

        // Wait until the video stream canvas play
        video.addEventListener(
          "canplay",
          function (e) {
            if (!isStreaming) {
              // videoWidth isn't always set correctly in all browsers
              if (video.videoWidth > 0)
                h = video.videoHeight / (video.videoWidth / w);
              canvas.setAttribute("width", w);
              canvas.setAttribute("height", h);
              isStreaming = true;
            }
          },
          false
        );

        // Wait for the video to start to play
        video.addEventListener("play", function () {
          // console.log('video play')
          //Setup image memory
          var id = ctx.getImageData(0, 0, canvas.width, canvas.height);
          var d = id.data;

          if (wasmModuleLoaded) {
            // console.log('wasm loaded')
            mallocAndCallSFilter();
          } else {
            wasmModuleLoadedCallbacks.push(mallocAndCallSFilter);
          }

          function mallocAndCallSFilter() {
            // console.log('mallocAndCallSFilter')
            if (pointer != null) {
              Module._free(pointer);
              pointer = null;
            }

            pointer = Module._malloc(d.length);
            sFilter();
          }
        });

        // check whether we can use facingMode
        var supports = navigator.mediaDevices.getSupportedConstraints();
        if (supports["facingMode"] === true) {
          switchcamerabtn.disabled = false;
        }

        switchcamerabtn.addEventListener("click", function () {
          if (stream == null) return;

          stream.getTracks().forEach((t) => {
            t.stop();
          });

          shouldFaceUser = !shouldFaceUser;
          capture();
        });

        capture();
      });

      function capture() {
        var constraints = {
          audio: false,
          video: {
            width: 640,
            height: 480,
            facingMode: shouldFaceUser ? "user" : "environment",
          },
        };
        navigator.mediaDevices
          .getUserMedia(constraints)
          .then(function (mediaStream) {
            var video = document.querySelector("video");
            stream = mediaStream;
            video.srcObject = mediaStream;
            video.onloadedmetadata = function (e) {
              video.play();
            };
          })
          .catch(function (err) {
            console.log(err.message);
          });
      }

      function ncnn_nanodet() {
        // console.log("running ncnn_nanodet");
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");

        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var data = imageData.data;

        // console.log('raw image data ', data)
        // console.log('pointer ', pointer)
        Module.HEAPU8.set(data, pointer);

        const objectsPointer = Module._nanodet_ncnn(pointer, canvas.width, canvas.height);
        const objects = Module.UTF8ToString(objectsPointer);
        console.log('objects ', objects)

        var result = Module.HEAPU8.subarray(pointer, pointer + data.length);
        // console.log('the heap ', Module.HEAPU8)
        // console.log('the results ', result);
        imageData.data.set(result);
        ctx.putImageData(imageData, 0, 0);
      }

      //Request Animation Frame function
      var sFilter = function () {
        // console.log("running sFilter");
        if (video.paused || video.ended) return;

        ctx.fillRect(0, 0, w, h);
        ctx.drawImage(video, 0, 0, w, h);

        ncnn_nanodet();

        window.requestAnimationFrame(sFilter);
      };
    </script>
  </body>
</html>
